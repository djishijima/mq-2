## ğŸ”§ **AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæˆæœç‰© æ°¸ç¶šä¿å­˜ãƒ»å…±æœ‰è¨­å®š æŒ‡ç¤ºæ›¸**

### 1ï¸âƒ£ JSONä¿å­˜ã‚¨ãƒ©ãƒ¼å¯¾ç­–

AIã®å‡ºåŠ›JSONã«æ—¥æœ¬èªãŒæ··å…¥ã™ã‚‹ã¨

> Unexpected token 'ä¼' ... is not valid JSON
> ãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `JSON.stringify()` ã‚’å¾¹åº•ã™ã‚‹ã“ã¨ã€‚

```js
const body = JSON.stringify({
  company_name: "ãƒ•ã‚©ãƒ¼ãƒ†ã‚£ã‚¨ãƒ³ã‚¹ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°æ ªå¼ä¼šç¤¾",
  contact_person: "ä¼Šè—¤",
  email: "somu@fortience.com"
});
```

---

### 2ï¸âƒ£ Supabase ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ è£œå®Œ

ä¸è¶³ã‚«ãƒ©ãƒ ã‚„schema cacheã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã€‚

```sql
BEGIN;

CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE IF NOT EXISTS public.customers (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid()
);

ALTER TABLE public.customers
  ADD COLUMN IF NOT EXISTS company_name text,
  ADD COLUMN IF NOT EXISTS representative text,
  ADD COLUMN IF NOT EXISTS phone_number text,
  ADD COLUMN IF NOT EXISTS email text,
  ADD COLUMN IF NOT EXISTS website_url text,
  ADD COLUMN IF NOT EXISTS address1 text,
  ADD COLUMN IF NOT EXISTS address2 text,
  ADD COLUMN IF NOT EXISTS ai_analysis jsonb,
  ADD COLUMN IF NOT EXISTS updated_at timestamptz DEFAULT now();

NOTIFY pgrst, 'reload schema';
COMMIT;
```

---

### 3ï¸âƒ£ AIç”Ÿæˆç‰© æ°¸ç¶šä¿å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

ææ¡ˆæ›¸ãƒ»è¦‹ç©ãƒ»è¿”ä¿¡ãªã©ã‚’ä¸€å…ƒç®¡ç†ã—ã€**èª°ã§ã‚‚é–²è¦§å¯èƒ½**ã«è¨­å®šã€‚

```sql
BEGIN;

CREATE TABLE IF NOT EXISTS public.ai_artifacts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  kind text NOT NULL,                 -- research|proposal|estimate|mail
  title text NOT NULL,
  lead_id uuid,
  customer_id uuid,
  body_md text,                       -- æœ¬æ–‡(MD/JSON)
  storage_path text,                  -- æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
  status text DEFAULT 'ready',
  created_by uuid,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE OR REPLACE FUNCTION public.touch_updated_at()
RETURNS trigger AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_touch_ai_artifacts ON public.ai_artifacts;
CREATE TRIGGER trg_touch_ai_artifacts
BEFORE UPDATE ON public.ai_artifacts
FOR EACH ROW EXECUTE FUNCTION public.touch_updated_at();

ALTER TABLE public.ai_artifacts ENABLE ROW LEVEL SECURITY;

CREATE POLICY ai_artifacts_read_all
  ON public.ai_artifacts FOR SELECT TO authenticated USING (true);
CREATE POLICY ai_artifacts_write_all
  ON public.ai_artifacts FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY ai_artifacts_write_all_update
  ON public.ai_artifacts FOR UPDATE TO authenticated USING (true) WITH CHECK (true);

-- å…¬é–‹ãƒã‚±ãƒƒãƒˆ
INSERT INTO storage.buckets (id, name, public)
VALUES ('ai','ai', true)
ON CONFLICT (id) DO NOTHING;

CREATE POLICY ai_read_public
  ON storage.objects FOR SELECT USING (bucket_id = 'ai');
CREATE POLICY ai_write_auth
  ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'ai');
CREATE POLICY ai_update_auth
  ON storage.objects FOR UPDATE TO authenticated USING (bucket_id = 'ai') WITH CHECK (bucket_id = 'ai');

NOTIFY pgrst, 'reload schema';
COMMIT;
```

---

### 4ï¸âƒ£ ä¿å­˜å‡¦ç†ä¾‹

```ts
// ä¼æ¥­èª¿æŸ»çµæœã‚’ä¿å­˜
await supabase.from('ai_artifacts').insert({
  kind: 'research',
  title: 'ä¼æ¥­èª¿æŸ»: ãƒ•ã‚©ãƒ¼ãƒ†ã‚£ã‚¨ãƒ³ã‚¹',
  lead_id,
  customer_id,
  body_md: researchMarkdown,
  created_by: user.id
});

// ææ¡ˆæ›¸PDFã‚’ä¿å­˜
const filePath = `ai/${lead_id}/proposal_${Date.now()}.pdf`;
await supabase.storage.from('ai').upload(filePath, fileBlob, { upsert: true });
await supabase.from('ai_artifacts').insert({
  kind: 'proposal',
  title: 'AIææ¡ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸',
  lead_id,
  customer_id,
  storage_path: filePath
});
```

---

### 5ï¸âƒ£ å…¬é–‹é–²è¦§ç¢ºèª

```ts
const { data } = await supabase
  .from('ai_artifacts')
  .select('*')
  .order('created_at', { ascending: false });

const publicUrl = supabase.storage.from('ai').getPublicUrl(filePath).data.publicUrl;
```

---

ğŸ“Œ **é‹ç”¨ç›®çš„**

* AIææ¡ˆæ›¸ãƒ»è¦‹ç©ãƒ»ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã‚’å±äººåŒ–ã›ãšä¿å­˜
* å…¨ç¤¾å“¡ãŒAIç”Ÿæˆçµæœã‚’å³æ™‚å…±æœ‰ãƒ»å†åˆ©ç”¨å¯èƒ½
* å¤–éƒ¨å‡ºåŠ›ã¯PDF/MD/JSONã§çµ±ä¸€ç®¡ç†